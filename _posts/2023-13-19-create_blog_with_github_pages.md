---
layout: post
title: "这是个人博客，分享一些自己感兴趣的东西"
date:   2023-03-19
tags: [geek]
comments: true
author: zhou-shaoming
---
搭建这个网站的初衷是好玩而已，但是既然已经做出来了，不放点东西进去实在对不起自己，那么就做一些简单的分享吧。

![blogPage](https://raw.githubusercontent.com/lemonchann/lemonchann.github.io/master/images/2019-11-22-create_blog_with_github_pages/blogPage.png)

<!-- more -->

# ISP图像信号处理

镜头：决定光学特性，对动态范围影响不大；

cmos：决定电子特性，是动态范围的第一道瓶颈；

成像引擎：保持sensor动态范围的关键，也是目前最大的短板；

AI算法：只能识别 8bit 标准的 jpeg 图像

# sensor 的问题以及ISP的处理原理

sensor 的物理缺陷导致下列问题，需要ISP模块去补偿。

## sensor 有漏电流

由于 sensor 有漏电流，全黑环境输出的数值不为 0，理想状态是全为 0.

### 黑电平校正（Black Level Correction）BLC

原因：AD转换芯片精度不够，电压值很小时转换不出来，为了保留暗部细节，芯片厂商会刻意添加一个固定的偏移量 pedestall 以达到阈值转换电压。

黑电平受曝光时间（温度）和亮度增益影响，且变化不均匀，但处理时常减去一个均值，导致RGB通道的比例发生变化，可能引起色偏。

找到一个矫正值，所有像素值都减去这个值，就得到一个矫正成功的结果。

一般情况下，sensor 传感器周边，有一小部分区域是有感光器的，但是没有光透射进来。可以把这部分传感器的信号作为矫正值，从可感光部分的信号中减去，就可获得校正后的信号。

部分sensor会直接给出blc值。

自己标定，测出BLCR、BLCGr、BLCGb、BLCB

校正位置：由于存在黑电平，图像输出信号非线性，一般放在 ISP 的最前端。在传感器数据输出后直接校正，变为线性数据。

校正方法：在 bayer 数据域进行，以8bit为例，sensor输出数据范围为 【blc，255】，实际表示的亮度为【0，255-blc】，而 8bit 最终输出的亮度为 【0，255】。

即得到两个方法：减掉blc后，乘以一个系数使得范围达到 【0，255】；减掉blc后，不乘以系数，由后续的gamma等其他方法将输出范围达到 【0，255】。

不做 blc 会影响 AWB CCM 等的准确性。

方案：在运行时调整，不需要依赖人工矫正。

## 通过镜头到达sensor的光，中间比边缘的多，即渐晕

由于镜头对于光学折射不均匀导致的镜头周围出现阴影的情况，，中间亮，边缘暗

亮度阴影（lamu shading）：凸透镜原理

![1677595054989](../image/2023-13-19-create_blog_with_github_pages/1677595054989.png)![1677595090301](../image/2023-13-19-create_blog_with_github_pages/1677595090301.png)

颜色阴影（color shading）：不同色彩不同的波长，不同的折射率

![1677595062290](../image/2023-13-19-create_blog_with_github_pages/1677595062290.png)![1677595105641](../image/2023-13-19-create_blog_with_github_pages/1677595105641.png)

### 镜头阴影校正LSC

原理：监测中间亮度均匀的部分，认为不需要矫正，以此为中心，计算出周围区域需要补偿的因子（增益）。实际操作中，把镜头对准白色物体，检查图像四周是否有暗角。

方法：分别对四个通道进行校正。考虑到芯片设计的成本，因此一般情况下不会存储整幅图像的lut，目前主流的都是存储128*128个点的增益，利用双线性插值的方法计算每个像素pixel的增益。

lut（look up table）：颜色查找表，一种颜色转换为对应的另一个颜色。理解为滤镜

存储128*128个点的增益：理想状态是对每个点进行增益，为了节省资源，取网格的交叉点，获得该点的增益。可理解为缩小后存储，使用时再放大。

![1677679661560](../image/2023-13-19-create_blog_with_github_pages/1677679661560.png)

双线性插值：在 x 方向上和 y 方向上各做一次线性插值。

方案：在运行前依赖人工矫正。

## sensor 像素坏点

sensor 是物理器件，难以避免坏点，随使用时间增多，高温环境也会增多。

在全黑环境，观察输出的亮点彩点，或白色物体下观察彩点和黑点。

静态坏点：

- 亮点：正常情况下，像素点的亮度值正比于入射光强度，异常时二者不成正比，亮度值异常的变大。曝光时间增加，亮度会显著增加。
- 暗点：无论什么入射光，接近于0。

动态坏点：在一定范围内，该点表现正常，超过时会表现的过亮。温度升高或增益加大时，动态坏点会更加明显。

存在坏点，插值和滤波时会影响其他像素点。坏点很多时边缘会出现伪色彩的情况

### 坏点校正（Bad Pixel Correction）BPC、（Defective Pixel Correction ） DPC

自动、动态：使用算法

- 监测坏点。在 RGB 域上做 5x5 的评估，如果某个点与周围的点偏离度超过阈值的点为坏点。防止误判，需采用更复杂的逻辑，如连续评估N帧。如梯度百分比检测坏点
- 纠正坏点。对找到的坏点做中值滤波，替换回原来的值即可。如中值滤波。

静态：建立坏点表，对固定位置修复。少部分厂商会提供，大多数是用户自己查找。

- 黑暗标定
- 有光均匀标定
- 建立坏点表

方案：运行时调整

## cmos 的 sensor 采用了 Bayer 色彩滤波阵列 Color Filter Array（CFA）

发明人：Bryce Bayer —— 柯达公司工程师

传感器上方的一层马赛克覆盖层，采集颜色信息。一般的光电传感器只能感受光的强度，不能分辨波长。

通过滤波只允许特定波长的光透过，收集不同波长的光强度，再通过色彩合成算法合成。常见的 RGGB Fliter。人眼对绿色更敏感。

bayer色彩滤波阵列中，二分之一是绿色，剩余二分之一是红色和蓝色，生成的值是三个颜色交替存在的，并不是完整的三个颜色分量的值。

![1678807093210](../image/2023-13-19-create_blog_with_github_pages/1678807093210.png)

### 颜色插值（color filter array）CFA

原理：通过距离最近的几个像素值，计算出当前像素的的值，插入缺失的位置上，形成完整的RGB三色值。常用的如内插法。

方案：运行时调整

![1676641759754](../image/2023-13-19-create_blog_with_github_pages/1676641759754.png)![1676641798453](../image/2023-13-19-create_blog_with_github_pages/1676641798453.png)

## sensor获取的图像有大量噪声

sensor 感光部件包含模拟部分，所以信号中的噪声很难避免，ADC器件本身也会引入噪声。另外，当光线较暗时，整个系统需要将信号放大，这样噪声也跟着放大。视觉感受为雪花点。

### Bayer 降噪（Bayer noise reduction） BNR

原理：均值滤波，高斯滤波等。本质是低通滤波器。

普通的高斯滤波只考虑像素的空间距离关系，这样会导致滤波后图像变的模糊，为了避免图像变模糊，就需要保留图像的边缘，这时就还要考虑相邻像素和本像素的相似程度，对于相似度高的像素给予更高的权重，我们称这种滤波为双边滤波。

方案：部分参数可提前调校，如调整滤波强弱。

## sensor 获取的图像容易受到光源颜色的影响。

人类的视觉系统有一定的颜色恒常性的特点，具有视觉修正的功能，不会受到光源颜色的影响。sensor不具备这样的特点。

### 自动白平衡 （Auto White Balance）AWB

原理：让不同色温光线条件下的白色物体，sensor 输出都转换为更接近白色。

白色的物体在不同的光照条件和白平衡参数下表现如下：

光照色温 == 白平衡设置色温 ：白色

光照色温  》 白平衡设置色温 ：偏冷，偏蓝色

光照色温 《  白平衡设置色温 ：偏暖，偏黄色

环境的色温是不停变化的，如：日出、正午太阳、阴天。所以需要自动白平衡适应变化。

步骤：

- 检测色温：估算图像白色位置，通常选取特定区域像素计算。需要有一定的约束条件。
- 计算增益：计算R/B要调整的增益，将Cr，Cb调整到接近0的两个系数，R=G=B。
- 色温矫正：根据增益调整色温。

理论：Von Kries 色适应

一个物体在光源 A 下 RGB 值为 RGB1 = 【R1，G1，B1】，在光源 B 下 RGB2 = 【R2，G2，B2】，那么每个通道存在一个系数将这两个值互相转换。RGB2 = {kr，0，0；0，kg，0；0，0，kb} * RGB1，其中 kr，kg，kb 为转换系数。

灰度世界算法：对于一张色彩丰富的图片，图像上 RGB 三个通道的平均值应该等于一个被成为灰色值的 K。灰色值有几种定义方式：

- 取各通道最大值的一半。如 255，则 k = 127 或 128
- 将待处理图片三个通道均值的均值作为灰色值。k = （R平均+G平均+B平均）/ 3

校正系数为 kr = K/Rmean，kg = K/Gmean，kb = K/Bmean。

![1676640369986](../image/2023-13-19-create_blog_with_github_pages/1676640369986.png)

完美反射法（镜面法）：图像中存在一个镜面，在特定光源下，获得的色彩信息认为是当前光源的信息。在进行校准的时候，假设存在镜面，则存在一个色值为 #FFFFFF 的纯白色像素点（有多种白色的定义）。此时校正系数为 kr = 255/Rmax，kg = 255/Gmax，kb = 255/Bmax。Rmax，Gmax，Bmax 为图像 RGB 通道的最大值。

方案：自动校正。

![](https://images2015.cnblogs.com/blog/697264/201707/697264-20170714100514931-829659881.png)

## sensor 滤光板处各颜色块之间的颜色渗透带来的颜色误差

因为颜色渗透，导致最终成像与实际存在偏差，故需要矫正。

白平衡对白色完成矫正，这一步对其他颜色进行矫正。

### 颜色校正 （Color Correction Matrix）CCM

原理：将拍摄到的图像与标准图像对比，计算得到一个校正矩阵。校正过程中都会伴随着饱和度的调整。

工具：标准 24 色卡，图像分析软件（imagetest）。

方案：手工校正。

## 人眼对暗部细节比sensor敏感

在黑暗条件下，随着光线逐渐增强，一开始人眼的感知非常明显，然后逐渐减弱。而sensor对光线变化的感知是线性的。

![1676642277927](../image/2023-13-19-create_blog_with_github_pages/1676642277927.png)

### Gamma 校正

原理：Gamma 编码后的图像相比于线性编码的图像，明显有更多的暗部色阶。满足人眼对暗部细节敏感的特性。

人眼是按照gamma < 1的曲线对输入图像进行处理的（公式f(I)=I^gamma，I为原图像素值）。

现在常用的伽马校正是利用查表法来实现的，即首先根据一个伽马值，将不同亮度范围的理想输出值在查找表中设定好，在处理图像的时候，只需要根据输入的亮度，既可以得到其理想的输出值。

方案：手工校正 Gamma 参数

## sensor 的输出的 RAW data 是RGB，但是有的处理在YUV上更方便，且YUV存储和传输时更省带宽。

在YUV色彩空间上进行彩色噪声去除、边缘增强等更方便。

### RGBtoYUV 色彩空间转换

原理：YUV是一种基本色彩空间，人眼对亮度 Y 改变的敏感性远比色彩变化大很多，因此，对于人眼而言，亮度分量 Y 要比色度分量 UV 重要的多。所以只有YUV 444 格式的 YUV 数据的比例是 1：1：1，其他各种格式，如 YUV422，YUV420 等格式，UV的数据量都小于 Y，达到节省空间和传输带宽的目的。

YUV 和 RGB 转换有固定的公式。

在 YUV 家族种， YCbCr 是在计算机系统中应用最多的成员，其应用领域很广泛，jpeg，mpeg 均采用此格式。一般人所指的大多是 YCbCr。

YCbCr的相互转换：Y = 0.299R + 0.587G+0.114B

    Cb = 0.564（B-Y）

    Cr = 0.713（R-Y）

实时计算，不需要提前调校

处理效果：人眼看不出图像质量变化

## sensor 在一定曝光量下，较暗部分或较亮部分的细节显示不充分

自然界中，光强度范围很宽，而人眼对高亮、极暗环境的细节分辨能力相对较窄，而摄像头记录的范围更窄，真正的 HDR 技术就是记录视觉范围高亮、极暗环境种的细节分辨率。

为保证人眼看到的世界和显示器后者摄像头采集的图像范围相差无几，甚至更好，需要通过色调映射（ tone mapping） ，将暗处和亮部细节再现，这是一种纯粹为了视觉感受而进行的处理，并非真正的 HDR。也有人成为 WDR。

### HDR

原理：通过tone mapping 的方法，将像素值在特别暗的区域拉高，在特别亮的区域拉低。

有以下几种：

- global tone mapping
  a. 单一 tone 曲线。对整幅图底拉高，高拉低。（缺点，蒙上一层雾的感觉，因为数值压缩后往中间靠拢，局部对比度下降）
  b. 双边滤波，tone mapping。在图像中局部边缘处不会进行 tone mapping，以保持局部细节。
- local tone mapping
  a.虚拟曝光。通过多帧相加确定哪些区域是高亮区，哪些区域是低亮区，然后分区进行 local tone mapping。
  b. local gamma。图片分成多块，对每块进行伽马校正。主要根据每块的亮度直方图进行动态调整 gamma 曲线。

处理流程：实时计算，且需要提前调校。

处理效果：HDR 或 WDR 仍然是手机相机重点竞争的领域，说明这个方向有长足进步，但仍有提升空间，而且是难点。

## YUV色彩空间需要进一步降噪和锐化。

主要是对 YUV 降噪处理，同时为了消除降噪过程中对图像细节的损失，需要对图像进行锐化处理，还原图像的相关细节。因为在 YUV 色彩空间，这些处理更方便

### color denoise 、sharpness

原理：为了抑制图像的彩色噪声，一般采用低通滤波器进行处理。例如使用 MxN 的高斯低通滤波器在色度通道上进行处理。

在 YUV 色彩空间上彩躁去除与边缘加强、色彩与对比度加强，中间还要进行自动曝光控制等，然后输出 YUV （或者RGB）格式的数据，再通过 I/O 接口传输到 CPU 中处理。

处理流程：实时计算，且需要提前调校。

处理效果：降噪的要求和效果总是不断提高的，而且降噪和锐化是相互矛盾的，所以会有各种不同的算法。

## 图像传感器和镜头需要 ISP 模块根据光强度自动调节曝光时间

不同场景下，光照强度有很大的区别。人眼有着自适应的能力，因此可以很快的调整，使自己可以感应到合适的亮度。而图像传感器却不具备这种自适应能力，因此必须使用自动曝光功能来确保拍摄的照片获得准确的曝光，从而具有合适的亮度。

### 自动曝光AEC（Automatic Exposure Control）

原理：

1. 光强测量：利用图像的曝光信息获得当前光照信息的过程。可以统计全部像素，也可以统计图像中间部分，也可以将图像分成不同部分，赋予不同的权重。
2. 场景分析：获得当前光照的特殊情况，如没有背光照射或正面强光。对这些信息进行分析，可提升图像传感器的易用性，大幅提高图像质量。主要有模糊逻辑和人工神经网络算法。这些算法比起固定分区测光算法具有更高的可靠性。
3. 曝光补偿：完成前两步之后，调节相应参数使得曝光调节生效。主要是调节曝光时间和曝光增益。

处理流程：实时计算，需要提前调校。

效果：自动曝光的需求总是不断提高的。

## 变焦镜头需要自动调节焦距

### 自动对焦AF

原理：判断图像的模糊程度，通过模糊度评价函数求得采集的每一幅图像评价值，通过搜索算法得到一系列评价值的峰值，通过点击驱动将采集设备调节到峰值所在的位置，得到最清晰的图像。

对焦评价函数：有很多种，主要考虑的有图像频率（清晰图像纹理多，高频分布较多），图像灰度分量的分布（灰度图的分量分布范围越大，说明细节越多，反映清晰程度。）

常见的搜索算法有：爬山算法，搜索窗口有黄金分割点对焦嵌套窗口等。

处理方式：实时计算，提前调校

效果：如手机。

## 3A

![1677508262906](../image/2023-13-19-create_blog_with_github_pages/1677508262906.png)
